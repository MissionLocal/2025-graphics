<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Rezoning proposal — Pym-safe embed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- Mapbox GL -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css" rel="stylesheet" />

  <!-- Geocoder (optional) -->
  <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.min.js"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;500;600&display=swap" rel="stylesheet" />

  <style>
    /* ========= Base ========= */
    html, body { height: 100%; }
    body {
      margin: 0;
      padding: 0 0 20px 0;
      font-family: Barlow, system-ui, sans-serif;
      background: #fff;
      color: #111;
    }

    /* ========= Layout ========= */
    .cont {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .map-container {
      position: relative;
      width: 100%;
      max-width: 900px;
      margin: 10px auto;
      box-sizing: border-box;
    }
    /* Map element — use % not vw for iframes */
    #map {
      width: 100%;
      height: 600px; /* desktop default */
      box-shadow: 0 4px 8px rgba(0,0,0,.1);
      border-radius: 6px;
    }

    /* ========= UI / Legend ========= */
    .map-ui {
      position: absolute;
      top: 8px; left: 8px; right: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 5;
    }
    .controls-row {
      display: flex; align-items: center; gap: 10px;
      align-self: flex-start;
      background: #fff; border-radius: 999px; border: 1px solid #ddd;
      padding: 6px 10px; box-shadow: 0 1px 2px rgba(0,0,0,.06);
      font: 500 14px/1.2 Barlow, sans-serif;
    }
    .legend {
      align-self: flex-start;
      max-width: 320px;
      background: rgba(255,255,255,.96);
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 8px 10px;
      box-shadow: 0 1px 2px rgba(0,0,0,.06);
      font-size: 12px;
      line-height: 1.2;
      pointer-events: none;
    }
    .legend-title { font: 600 12px/1.2 Barlow, sans-serif; color: #222; margin-bottom: 4px; }
    .legend-gradient { height: 10px; border-radius: 6px; box-shadow: inset 0 0 0 1px rgba(0,0,0,.08); }
    .legend-ends { display: flex; justify-content: space-between; margin-top: 4px; color: #222; }
    .legend-ends span { font-weight: 400; color: #555; }

    /* Mapbox controls under our UI */
    .mapboxgl-ctrl-top-right { z-index: 4; }

    /* ========= Info card ========= */
    #info-box {
      position: absolute;
      left: 50%; transform: translateX(-50%);
      bottom: 14px;
      z-index: 2;
      width: calc(100% - 12px);
      max-width: 460px;
      box-sizing: border-box;
      padding: 10px 12px;
      background: rgba(255,255,255,.98);
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,.1);
      font-size: 13px; line-height: 1.35;
      max-height: 40%;
      overflow-y: auto;
      display: none;
    }
    .info-header { display: flex; align-items: baseline; gap: 6px; }
    .info-header .sep { opacity: .5; }
    .info-stats { margin-top: 4px; color: #333; }

    /* ========= Responsive ========= */
    @media (min-width: 1280px){
      .map-container { max-width: 1100px; }
      #map { height: 700px; }
    }
    @media (min-width: 768px) and (max-width: 1279px){
      .map-container { max-width: 720px; }
      #map { height: 560px; }
    }
    @media (max-width: 767px){
      .map-container { max-width: none; margin: 8px auto; padding: 4px; }
      #map { height: 500px !important; min-height: 500px !important; }
      .legend { max-width: none; }
    }
  </style>
</head>
<body>
  <div class="cont">
    <div id="geocoder-container" style="max-width:320px; width:100%; margin:10px;"></div>
  </div>

  <!-- Optional tab/radio UI; if you use it, it’ll also hide the info box on change -->
  <div class="cont">
    <form id="layer-toggle" class="controls-row" aria-label="Layer toggle">
      <label><input type="radio" name="layer" value="proposal" checked> Rezoning proposal</label>
      <label><input type="radio" name="layer" value="alternate"> Current zoning</label>
    </form>
  </div>

  <div class="map-container">
    <div class="map-ui">
      <div class="controls-row">
        <label for="layerSelect">Filter:</label>
        <select id="layerSelect">
          <option value="all" selected>All parcels</option>
          <option value="RC">Residential-Commercial (RC = true)</option>
          <option value="SRES">Single-family (SRES = true)</option>
          <option value="MRES">Multi-residential (MRES = true)</option>
          <option value="COMM">Commercial (COMM = true)</option>
        </select>
      </div>
      <div id="legend" class="legend"></div>
    </div>

    <div id="map" role="region" aria-label="Zoning map"></div>
    <div id="info-box" aria-live="polite"></div>
  </div>

  <!-- Pym AFTER body content so parent can size once it exists -->
  <script src="https://pym.nprapps.org/pym.v1.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ---- One Pym child only ----
      let pymChild = null;
      try { if (window.pym) pymChild = new pym.Child(); } catch {}

      // ---- Config (yours) ----
      mapboxgl.accessToken = "pk.eyJ1IjoibWxub3ciLCJhIjoiY21ncjMxM2QwMnhjajJvb3ZobnllcDdmOSJ9.dskkEmEIuRIhKPkTh5o_Iw";
      const TILESET_URL  = "mapbox://mlnow.01iokrpa";
      const SOURCE_LAYER = "gdf_supe_with_categories";

      const HEIGHT_BREAKS = [40,50,65,70,75,80,85,105,120,130,140,160,180,240,250,300,350,450,490,500,650];
      const HEIGHT_COLORS = ["#9DF4D9","#66D9CF","#3CCDC9","#22BFC3","#12ADBA","#008FA4","#007DBC","#006FB0","#0062A1","#005892","#004F84","#004676","#003C66","#003459","#002C4D","#00233F","#001C31","#001724","#001319","#000F19","#000C13"];
      const BASE_BELOW_FIRST = "#EFFFFA";
      const EXACT_FORTY_COLOR = "#9e9e9e";
      const MISSING_COLOR = "#E6E6E6";

      // ---- DOM refs ----
      const mapEl    = document.getElementById('map');
      const infoBox  = document.getElementById('info-box');
      const legendEl = document.getElementById('legend');
      const selectEl = document.getElementById('layerSelect');
      const layerToggle = document.getElementById('layer-toggle');
      if (infoBox) infoBox.style.display = 'none';

      // ---- Helpers ----
      function sendHeightAfterLayout(map) {
        if (!pymChild) return;
        const fontsReady = (document.fonts?.ready ?? Promise.resolve());
        const styleReady = map
          ? (map.isStyleLoaded && map.isStyleLoaded()) ? Promise.resolve()
            : new Promise(res => map.once('idle', res))
          : Promise.resolve();

        Promise.all([fontsReady, styleReady]).then(() => {
          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              setTimeout(() => { try { pymChild.sendHeight(); } catch {} }, 60);
            });
          });
        });
      }
      function robustClassFilter(key) {
        return [
          "any",
          ["==", ["get", key], true],
          ["==", ["downcase", ["coalesce", ["to-string", ["get", key]], ""]], "true"],
          ["==", ["coalesce", ["to-number", ["get", key]], 0], 1]
        ];
      }
      const toNum = v => {
        if (v==null) return null;
        if (typeof v==="number") return Number.isFinite(v) ? v : null;
        const s=String(v).trim();
        if(!s || /^(null|na|n\/a|none|undefined|nan)$/i.test(s)) return null;
        const m=s.match(/^[+-]?\d+(\.\d+)?/);
        return m?Number(m[0]):null;
      };
      const asNum = v => { const n=Number(v); return Number.isFinite(n)?n:null; };
      const pickField = (o, ns) => ns.map(n => o?.[n]).find(v => v !== undefined);
      const fallbackChange = p => {
        const pr=toNum(p?.proposed_height_int ?? p?.proposed_height);
        const ex=toNum(p?.heightdist);
        return (pr!=null && ex!=null) ? pr-ex : null;
      };
      function tplInfo(p = {}) {
        const id=p?.RP1PRCLID ?? "—";
        const type=p?.class_desc ?? p?.RP1CLACDE ?? "—";
        const rawPH=(p?.proposed_height ?? "").toString().trim();
        const nums=rawPH.match(/[+-]?\d+(\.\d+)?/g) || [];
        const isMultiple=!rawPH || /^\s*nan\s*$/i.test(rawPH) || /[;/]/.test(rawPH) || nums.length>1;
        const propStr=isMultiple ? "multiple" : (rawPH || "N/A");
        let ch=toNum(p?.change); if(ch==null) ch=fallbackChange(p);
        let changeTxt="—";
        if(ch!=null){
          const r = Math.abs(ch%1)===0 ? Math.trunc(ch) : Math.round(ch*10)/10;
          const sign = ch>0?"+":ch<0?"−":"";
          changeTxt = `${sign}${Number.isInteger(r)?r:r.toFixed(1)} ft`;
        }
        const unitsRaw=pickField(p,["UNITS","Units","units","UNIT_CT","UNITCOUNT","unit_count","UnitCount"]);
        const unitsNum=asNum(unitsRaw);
        const unitsTxt=(unitsNum!=null && unitsNum>0)?` • Units: ${Math.round(unitsNum).toLocaleString()}`:"";
        return `<div class="info-header"><strong>Parcel ${id}</strong><span class="sep">•</span><span class="bldg-type">${type}</span></div>
                <div class="info-stats">Proposed height: ${propStr} • Change: ${changeTxt}${unitsTxt}</div>`;
      }
      function makeHeightColorExprStep() {
        const raw = ["get", "proposed_height"];
        const v = ["to-number", raw];
        return ["case",
          ["any", ["==", raw, null], ["!=", v, v]], MISSING_COLOR,
          ["==", v, 40], EXACT_FORTY_COLOR,
          ["<", v, 40], BASE_BELOW_FIRST,
          ["step", v,
            BASE_BELOW_FIRST,
            40, HEIGHT_COLORS[0], 50, HEIGHT_COLORS[1], 65, HEIGHT_COLORS[2],
            70, HEIGHT_COLORS[3], 75, HEIGHT_COLORS[4], 80, HEIGHT_COLORS[5],
            85, HEIGHT_COLORS[6], 105, HEIGHT_COLORS[7], 120, HEIGHT_COLORS[8],
            130, HEIGHT_COLORS[9], 140, HEIGHT_COLORS[10], 160, HEIGHT_COLORS[11],
            180, HEIGHT_COLORS[12], 240, HEIGHT_COLORS[13], 250, HEIGHT_COLORS[14],
            300, HEIGHT_COLORS[15], 350, HEIGHT_COLORS[16], 450, HEIGHT_COLORS[17],
            490, HEIGHT_COLORS[18], 500, HEIGHT_COLORS[19], 650, HEIGHT_COLORS[20]
          ]
        ];
      }
      function legendHTML(title){
        const min = HEIGHT_BREAKS[0] + 1;
        const max = HEIGHT_BREAKS.at(-1);
        return `
          <div class="legend-title">${title}</div>
          <div class="legend-keys" style="display:flex;gap:14px;flex-wrap:wrap;margin:6px 0 6px;">
            <div class="k" style="display:flex;align-items:center;gap:6px;">
              <span class="sw" style="width:12px;height:12px;border-radius:2px;background:${EXACT_FORTY_COLOR};
                     box-shadow:inset 0 0 0 1px rgba(0,0,0,.12);"></span>
              <span>40, no change</span>
            </div>
          </div>
          <div class="legend-gradient"
               style="width:100%;height:10px;border-radius:6px;background:linear-gradient(90deg, ${HEIGHT_COLORS.join(',')});"></div>
          <div class="legend-ends" style="display:flex;justify-content:space-between;margin-top:4px;">
            <span>${min}</span><span>${max}</span>
          </div>`;
      }

      // ---- Build legend once ----
      if (legendEl){
        legendEl.style.display = 'inline-block';
        legendEl.innerHTML = legendHTML('Proposed height (ft)');
      }

      // ---- Map ----
      const map = new mapboxgl.Map({
        container: mapEl,
        style: 'mapbox://styles/mlnow/cm2tndow500co01pw3fho5d21',
        center: [-122.4411568, 37.765044],
        zoom: 11.85,
        minZoom: 10.4
      });

      // geocoder (optional)
      const geocoder = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        mapboxgl: mapboxgl,
        bbox: [-123.1738, 37.6398, -122.2818, 37.9298],
        placeholder: 'Search for your address',
        marker: true,
        zoom: 16
      });
      const gcWrap = document.getElementById('geocoder-container');
      if (gcWrap) {
        gcWrap.appendChild(geocoder.onAdd(map));
        geocoder.on('result', () => sendHeightAfterLayout(map));
        geocoder.on('clear',  () => sendHeightAfterLayout(map));
      }

      map.on('load', () => {
        // put labels above fills later
        const firstSymbolId = (map.getStyle().layers.find(l => l.type === 'symbol') || {}).id;

        map.addSource('parcels', { type: 'vector', url: TILESET_URL });
        map.addLayer(
          { id:'parcels-fill', type:'fill', source:'parcels', 'source-layer':SOURCE_LAYER,
            paint:{ 'fill-color': makeHeightColorExprStep(), 'fill-opacity':0.9 } },
          firstSymbolId
        );
        map.addLayer(
          { id:'outline', type:'line', source:'parcels', 'source-layer':SOURCE_LAYER,
            paint:{ 'line-color':'#ffffff', 'line-width':0.2 } },
          firstSymbolId
        );
        map.addLayer(
          { id:'hover', type:'line', source:'parcels', 'source-layer':SOURCE_LAYER,
            paint:{ 'line-color':'#ffffff', 'line-width':2.0 },
            filter:['==',['get','RP1PRCLID'],'' ] },
          firstSymbolId
        );

        // keep street labels on top (best-effort)
        try {
          map.moveLayer('road-label-navigation');
          map.moveLayer('settlement-subdivision-label');
        } catch {}

        // hover cursor + outline
        map.on('mousemove', 'parcels-fill', e => {
          if (!e.features?.length) return;
          const pid = e.features[0].properties?.RP1PRCLID ?? '';
          map.setFilter('hover', ['==', ['get','RP1PRCLID'], pid]);
          map.getCanvas().style.cursor = 'pointer';
        });
        map.on('mouseleave', 'parcels-fill', () => {
          map.setFilter('hover', ['==', ['get','RP1PRCLID'], '' ]);
          map.getCanvas().style.cursor = '';
        });

        // click feature -> show info
        map.on('click', 'parcels-fill', e => {
          const f = e.features?.[0]; if (!f) return;
          if (infoBox) {
            infoBox.innerHTML = tplInfo(f.properties || {});
            infoBox.style.display = 'block';
            sendHeightAfterLayout(map);
          }
        });

        // click basemap (not on feature) -> hide info
        map.on('click', e => {
          const features = map.queryRenderedFeatures(e.point, { layers: ['parcels-fill'] });
          if (!features.length && infoBox && infoBox.style.display !== 'none') {
            infoBox.style.display = 'none';
            sendHeightAfterLayout(map);
          }
        });

        // initial height after map + fonts settle
        sendHeightAfterLayout(map);
      });

      // filter dropdown
      if (selectEl){
        const applyFilter = () => {
          const key = selectEl.value;
          const filt = (key === 'all') ? null : robustClassFilter(key);
          if (map.getLayer('parcels-fill')) map.setFilter('parcels-fill', filt);
          if (map.getLayer('outline'))      map.setFilter('outline', filt);
          // hide info if filter changes
          if (infoBox) infoBox.style.display = 'none';
          sendHeightAfterLayout(map);
        };
        selectEl.addEventListener('change', applyFilter);
      }

      // optional: hide info when switching tabs/radios
      if (layerToggle) {
        layerToggle.addEventListener('change', () => {
          if (infoBox) infoBox.style.display = 'none';
          sendHeightAfterLayout(map);
        });
      }

      // ESC hides info
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && infoBox && infoBox.style.display !== 'none') {
          infoBox.style.display = 'none';
          sendHeightAfterLayout(map);
        }
      });

      // resize + map idle -> resync height (idle is safe and infrequent)
      window.addEventListener('resize', () => sendHeightAfterLayout(map));
      map.on?.('idle', () => sendHeightAfterLayout(map));

      // first paint (in case WP measures early)
      sendHeightAfterLayout(null);
    });
  </script>
</body>
</html>
