<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Rezoning proposal — Single map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- Mapbox -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;500;600&display=swap" rel="stylesheet" />

  <style>
    html, body { min-height: 100%; }
    body {
      margin: 0;
      padding: 0 0 20px 0;
      font-family: 'Barlow', system-ui, sans-serif;
      background: #fff; color: #111;
    }

    /* Force centering even inside WP flex/grids */
    .outer {
      display: flex;
      justify-content: center;
      width: 100%;
    }

    /* Main wrapper */
    .map-wrapper {
      width: 650px;
      max-width: 650px;
      margin: 10px auto;
      display: block;             /* block so margin auto centers */
      align-self: center;         /* if parent is flex */
    }

    /* Position overlay elements relative to the map area */
    .map-container {
      position: relative;
      width: 100%;
      height: 500px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0,0,0,.1);
      background: #f5f5f5;
    }

    #map { position: absolute; inset: 0; }

    /* Legend lives above map, centered under it */
    #legend {
      margin-top: 10px;
      background: rgba(255,255,255,.95);
      border: 1px solid #ddd; border-radius: 2px;
      padding: 8px 10px;
      box-shadow: 0 1px 2px rgba(0,0,0,.06);
      font-size: 11.5px; line-height: 1.1;
      display: inline-block; max-width: 260px;
    }
    .legend-title { font-weight: 600; color: #222; margin-bottom: 4px; }
    .legend-gradient { height: 10px; border-radius: 6px; box-shadow: inset 0 0 0 1px rgba(0,0,0,.08); }
    .legend-ends { display: flex; justify-content: space-between; margin-top: 4px; color: #222; }
    .legend-ends span { color: #555; font-weight: 400; }

    /* Overlay info card sits INSIDE the map (bottom-left by default) */
    #info-box {
      position: absolute;
      left: 22px; bottom: 22px;
      max-width: calc(100% - 44px); /* keep inside map */
      padding: 10px 12px;
      background: rgba(255,255,255,.98);
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,.15);
      font-size: 13px; line-height: 1.35;
      display: none;
      z-index: 2;
    }

    @media (max-width:640px) {
      .map-wrapper { width: auto; max-width: 100%; padding: 0 10px; }
      .map-container { height: 300px; min-height: 300px; }
      #legend { font-size: 11px; max-width: 240px; }
      #info-box { font-size: 12.5px; left: 14px; right: 14px; max-width: calc(100% - 28px); }
    }
  </style>
</head>
<body>
  <div class="outer">
    <div class="map-wrapper" id="mapWrapper">
      <div class="map-container">
        <div id="map"></div>
        <div id="info-box"></div>
      </div>
      <div id="legend"></div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ---------- Map config ----------
      mapboxgl.accessToken = "pk.eyJ1IjoibWxub3ciLCJhIjoiY21ncjMxM2QwMnhjajJvb3ZobnllcDdmOSJ9.dskkEmEIuRIhKPkTh5o_Iw";
      const TILESET_URL = "mapbox://mlnow.01iokrpa";
      const SOURCE_LAYER = "gdf_supe_with_categories";

      const HEIGHT_BREAKS = [40,50,65,70,75,80,85,105,120,130,140,160,180,240,250,300,350,450,490,500,650];
      const HEIGHT_COLORS = ["#9DF4D9","#66D9CF","#3CCDC9","#22BFC3","#12ADBA","#008FA4","#007DBC","#006FB0","#0062A1","#005892","#004F84","#004676","#003C66","#003459","#002C4D","#00233F","#001C31","#001724","#001319","#000F19","#000C13"];
      const BASE_BELOW_FIRST = "#EFFFFA";
      const EXACT_FORTY_COLOR = "#9e9e9e";
      const MISSING_COLOR = "#E6E6E6";

      function makeHeightColorExprStep() {
        const raw = ["get", "proposed_height"];
        const v = ["to-number", raw];
        return ["case",
          ["any", ["==", raw, null], ["!=", v, v]], MISSING_COLOR,
          ["==", v, 40], EXACT_FORTY_COLOR,
          ["<", v, 40], BASE_BELOW_FIRST,
          ["step", v,
            BASE_BELOW_FIRST,
            40, HEIGHT_COLORS[0], 50, HEIGHT_COLORS[1], 65, HEIGHT_COLORS[2],
            70, HEIGHT_COLORS[3], 75, HEIGHT_COLORS[4], 80, HEIGHT_COLORS[5],
            85, HEIGHT_COLORS[6], 105, HEIGHT_COLORS[7], 120, HEIGHT_COLORS[8],
            130, HEIGHT_COLORS[9], 140, HEIGHT_COLORS[10], 160, HEIGHT_COLORS[11],
            180, HEIGHT_COLORS[12], 240, HEIGHT_COLORS[13], 250, HEIGHT_COLORS[14],
            300, HEIGHT_COLORS[15], 350, HEIGHT_COLORS[16], 450, HEIGHT_COLORS[17],
            490, HEIGHT_COLORS[18], 500, HEIGHT_COLORS[19], 650, HEIGHT_COLORS[20]
          ]
        ];
      }

      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mlnow/cm2tndow500co01pw3fho5d21',
        center: [-122.4411568, 37.765044],
        zoom: 11.85,
        minZoom: 10.4
      });

      const infoBox = document.getElementById('info-box');
      const legendEl = document.getElementById('legend');
      const legendHTML = (title) => {
        const min = HEIGHT_BREAKS[0] + 1, max = HEIGHT_BREAKS.at(-1);
        return `
          <div class="legend-title">${title}</div>
          <div style="display:flex;gap:14px;flex-wrap:wrap;margin:6px 0 6px;">
            <div style="display:flex;align-items:center;gap:6px;">
              <span class="sw" style="width:12px;height:12px;border-radius:2px;background:${EXACT_FORTY_COLOR};box-shadow:inset 0 0 0 1px rgba(0,0,0,.12);"></span>
              <span>40, no change</span>
            </div>
          </div>
          <div class="legend-gradient" style="width:100%;background:linear-gradient(90deg,${HEIGHT_COLORS.join(',')});height:10px;"></div>
          <div class="legend-ends"><span>${min}</span><span>${max}</span></div>
        `;
      };

      map.on('load', () => {
        const firstSymbolId = (map.getStyle().layers.find(l => l.type === 'symbol') || {}).id;

        map.addSource('parcels', { type: 'vector', url: TILESET_URL });

        map.addLayer({
          id: 'parcels-fill',
          type: 'fill',
          source: 'parcels',
          'source-layer': SOURCE_LAYER,
          paint: { 'fill-color': makeHeightColorExprStep(), 'fill-opacity': 0.9 }
        }, firstSymbolId);

        map.addLayer({
          id: 'outline',
          type: 'line',
          source: 'parcels',
          'source-layer': SOURCE_LAYER,
          paint: { 'line-color': '#fff', 'line-width': 0.2 }
        }, firstSymbolId);

        if (legendEl) {
          legendEl.innerHTML = legendHTML('Proposed height (ft)');
          legendEl.style.display = 'inline-block';
        }

        // Show/hide info box (now overlays inside map)
        map.on('click', 'parcels-fill', e => {
          const f = e.features?.[0]; if (!f) return;
          const p = f.properties;
          const id = p?.RP1PRCLID || '—';
          const type = p?.class_desc || p?.RP1CLACDE || '—';
          const ph = p?.proposed_height ?? '—';
          const ch = (p?.change ?? p?.height_difference);
          const chTxt = (ch === null || ch === undefined) ? '—' : `${Number(ch).toFixed(0)} ft`;
          infoBox.innerHTML = `<strong>Parcel ${id}</strong> • ${type}<br>Proposed height: ${ph} • Change: ${chTxt}`;
          infoBox.style.display = 'block';
        });

        map.on('click', e => {
          const hit = map.queryRenderedFeatures(e.point, { layers: ['parcels-fill'] });
          if (!hit.length && infoBox.style.display !== 'none') {
            infoBox.style.display = 'none';
          }
        });
      });

      // Keep map sized if theme changes layout width
      let rT = null;
      window.addEventListener('resize', () => {
        clearTimeout(rT);
        rT = setTimeout(() => { try { map.resize(); } catch {} }, 150);
      }, { passive: true });
    });
  </script>
</body>
</html>
