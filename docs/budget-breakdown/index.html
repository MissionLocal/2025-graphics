<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>San Francisco Budget Treemap</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://pym.nprapps.org/pym.v1.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding-bottom: 5px;
    }

    .cont {
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
    }

    svg {
      width: 100%;
      height: auto;
      display: block;
      font-family: Barlow, sans-serif;
    }

    rect {
      stroke: #fff;
    }

    text {
      font-size: 16px;
      pointer-events: none;
      line-height: 1.2;
    }

    /* Popup Styling */
    .popup {
      position: absolute;
      background-color: white;
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
      padding: 10px;
      border-radius: 5px;
      display: none;
      z-index: 9999;
      max-width: 250px;
      word-wrap: break-word;
      overflow-wrap: break-word;
      font-family: Barlow, sans-serif;
    }

    .popup-header {
      font-size: 18px;
    }

    .popup-content {
      margin-top: 10px;
    }

    /* Close button for the popup */
    .popup-close {
      cursor: pointer;
      color: black;
      font-weight: bold;
      font-size: 16px;
      position: absolute;
      top: 5px;
      right: 5px;
    }

    /* Legend Styling */
    #legend {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 800px;
      margin: 20px auto;  /* Space between chart and legend, centered */
      margin-top: 20px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      border-radius: 4px;
    }

    .legend-label {
      font-size: 14px;
      font-family: Barlow, sans-serif;
    }
  </style>
</head>

<body>
  <div class="cont">
    <svg></svg>
  </div>

  <!-- Popup Container -->
  <div id="popup" class="popup">
    <span id="popup-close" class="popup-close">X</span>
    <div id="popup-header" class="popup-header"></div>
    <div id="popup-content" class="popup-content"></div>
  </div>

  <!-- Legend Container -->
  <div class="cont" id="legend"></div>

  <script>
    d3.json("Budget_2026.json").then(flatData => {
      window.pymChild = new pym.Child(); // Initialize pym child

      // Generate the Legend only once, outside of the render function
      function createLegend(orgGroups, customColors) {
        const legendContainer = d3.select("#legend");
        
        // Clear any previous legend (in case of dynamic updates)
        legendContainer.selectAll("*").remove();
        
        orgGroups.forEach((orgGroup, i) => {
          const legendItem = legendContainer.append("div")
            .attr("class", "legend-item");

          legendItem.append("div")
            .attr("class", "legend-color")
            .style("background-color", customColors[i]);

          legendItem.append("span")
            .attr("class", "legend-label")
            .text(orgGroup);  // Label for the organization group
        });
      }

      // Render the Treemap
      function render() {
        const container = document.querySelector('.cont');
        const width = container.clientWidth;
        const isMobile = window.innerWidth < 600;
        const height = isMobile ? width * 3 : width * 1;  // Keep height responsive for mobile

        const svg = d3.select("svg")
          .attr("width", width)
          .attr("height", height);

        svg.selectAll("*").remove();

        // Custom Color Scheme with opacity 0.8
        const customColors = [
          "rgba(70, 193, 52, 0.6)",  // green: #46c134
          "rgba(237, 67, 229, 0.6)", // pink: #ed43e5
          "rgba(244, 212, 110, 0.6)", // yellow: #f4d46e
          "rgba(239, 159, 106, 0.6)", // light orange: #ef9f6a
          "rgba(13, 214, 199, 0.6)", // light blue: #0dd6c7
          "rgba(216, 150, 255, 0.6)", // purple: #d896ff
          "rgba(74, 134, 232, 0.6)"  // dark blue: #4a86e8
        ];

        const orgGroups = Array.from(new Set(
          flatData.map(d => d.name?.split('.')[1]).filter(Boolean)
        ));

        // Call the createLegend function once
        createLegend(orgGroups, customColors);

        const colorScale = d3.scaleOrdinal()
          .domain(orgGroups)
          .range(customColors);

        const stratified = d3.stratify()
          .id(d => d.name)
          .parentId(d => {
            const parts = d.name.split('.');
            return parts.length > 1 ? parts.slice(0, -1).join('.') : null;
          })(flatData);

        const root = d3
          .hierarchy(stratified)
          .sum(d => d.data?.size ?? 0)
          .sort((a, b) => b.value - a.value);

        d3.treemap()
          .size([width, height])
          .padding(1)(root);

        const nodes = svg.selectAll("g")
          .data(root.leaves())
          .enter().append("g")
          .attr("transform", d => `translate(${d.x0},${d.y0})`);

        nodes.append("rect")
          .attr("width", d => d.x1 - d.x0)
          .attr("height", d => d.y1 - d.y0)
          .attr("fill", d => {
            const orgGroup = d.ancestors().find(a => a.depth === 1)?.data.id;
            const groupName = orgGroup?.split('.')[1];
            return colorScale(groupName);
          })
          .on("click", function (event, d) {
            const popup = document.getElementById("popup");
            const header = document.getElementById("popup-header");
            const content = document.getElementById("popup-content");

            const label = d.data.id.split('.')[2] || "No Name";
            const size = d.data.data?.size ?? 0;
            const description = d.data.data?.description || "No description available.";

            let formattedSize = "";
            if (size >= 1_000_000_000) {
              const sizeInBillions = size / 1_000_000_000;
              formattedSize = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                maximumFractionDigits: 1
              }).format(sizeInBillions) + 'B';
            } else if (size >= 1_000_000) {
              const sizeInMillions = size / 1_000_000;
              formattedSize = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                maximumFractionDigits: 1
              }).format(sizeInMillions) + 'M';
            } else {
              formattedSize = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                maximumFractionDigits: 1
              }).format(size);
            }

            header.innerText = label;
            content.innerHTML = `${description}<br><br>Budget: ${formattedSize}`;

            popup.style.left = `${event.pageX + 10}px`;
            popup.style.top = `${event.pageY + 10}px`;
            popup.style.display = "block";
          });

        nodes.append("text")
          .attr("x", 4)
          .attr("y", 14)
          .each(function (d) {
            const departmentCode = d.data.data?.department_code || '';
            const boxWidth = d.x1 - d.x0;
            const boxHeight = d.y1 - d.y0;

            if (boxWidth > 60 && boxHeight > 20) {
              const textElement = d3.select(this);
              textElement.text(departmentCode);
            }
          });

        // Close the popup when clicking on the close button
        document.getElementById("popup-close").addEventListener("click", function () {
          document.getElementById("popup").style.display = "none";
        });

        // ðŸ”„ Notify parent of height
        if (window.pymChild) {
          window.pymChild.sendHeight();
        }
      }

      render();

      // Debounced resize + Pym update
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          render();
          if (window.pymChild) {
            window.pymChild.sendHeight();
          }
        }, 150);
      });
    });
  </script>
</body>

</html>
