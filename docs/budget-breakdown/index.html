<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>San Francisco Budget Treemap</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://pym.nprapps.org/pym.v1.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: Barlow, sans-serif;
      margin: 0;
      padding-bottom: 10px;
    }

    .cont {
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
      padding: 10px;
    }

    svg {
      width: 100%;
      height: auto;
      display: block;
    }

    rect {
      stroke: #fff;
    }

    text {
      font-size: 16px;
      pointer-events: none;
      line-height: 1.2;
      fill: #000;
    }

    .popup {
      position: absolute;
      background-color: white;
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
      padding: 10px;
      border-radius: 5px;
      display: none;
      z-index: 9999;
      max-width: 250px;
      font-family: Barlow, sans-serif;
    }

    .popup-header {
      font-size: 18px;
      font-weight: bold;
    }

    .popup-category {
      display: inline-block;
      font-size: 12px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 3px;
      margin-top: 6px;
      margin-bottom: 8px;
    }

    .popup-content {
      font-size: 14px;
    }

    .popup-close {
      cursor: pointer;
      color: black;
      font-weight: bold;
      font-size: 16px;
      position: absolute;
      top: 5px;
      right: 5px;
    }
    #legend {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 10px 20px;
  width: 100%;
  max-width: 800px;
  margin-top: 20px;
}

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      border-radius: 4px;
      margin-left: 2px;
    }

    .legend-label {
      font-size: 14px;
    }

    #searchBox {
      width: 100%;
      padding: 8px;
      font-size: 16px;
      font-family: Barlow, sans-serif;
      margin-bottom: 12px;
      max-width: 300px;
    }
  </style>
</head>

<body>

  <div class="cont" id="legend"></div>
  <div class="cont">
    <input type="text" id="searchBox" placeholder="Search for a department..." />
  </div>
  <div class="cont">
    <svg></svg>
  </div>

  <div id="popup" class="popup">
    <span id="popup-close" class="popup-close">X</span>
    <div id="popup-header" class="popup-header"></div>
    <div id="popup-category" class="popup-category"></div>
    <div id="popup-content" class="popup-content"></div>
  </div>

  <script>
    function isDarkColor(rgbStr) {
      const rgb = rgbStr.match(/\d+/g)?.map(Number);
      if (!rgb || rgb.length < 3) return false;
      const luminance = 0.299 * rgb[0] + 0.587 * rgb[1] + 0.114 * rgb[2];
      return luminance < 140;
    }

    d3.json("Budget_2026.json").then(flatData => {
      window.pymChild = new pym.Child();

      const customColors = [
        "rgba(70, 193, 52, 0.6)",
        "rgba(237, 67, 229, 0.6)",
        "rgba(244, 212, 110, 0.6)",
        "rgba(239, 159, 106, 0.6)",
        "rgba(13, 214, 199, 0.6)",
        "rgba(216, 150, 255, 0.6)",
        "rgba(74, 134, 232, 0.6)"
      ];

      const orgGroups = Array.from(new Set(flatData.map(d => d.name?.split('.')[1]).filter(Boolean))).sort();

      const colorScale = d3.scaleOrdinal()
        .domain(orgGroups)
        .range(customColors);

      function createLegend() {
        const legendContainer = d3.select("#legend");
        legendContainer.selectAll("*").remove();

        orgGroups.forEach((orgGroup, i) => {
          const item = legendContainer.append("div").attr("class", "legend-item");
          item.append("div")
            .attr("class", "legend-color")
            .style("background-color", customColors[i]);
          item.append("span")
            .attr("class", "legend-label")
            .text(orgGroup);
        });
      }

      function render() {
        const width = document.querySelector("svg").clientWidth;
        const isMobile = window.innerWidth < 600;
        const height = isMobile ? width * 3 : width * 1;

        const svg = d3.select("svg")
          .attr("width", width)
          .attr("height", height)
          .selectAll("*").remove();

        const stratified = d3.stratify()
          .id(d => d.name)
          .parentId(d => {
            const parts = d.name.split('.');
            return parts.length > 1 ? parts.slice(0, -1).join('.') : null;
          })(flatData);

        const root = d3.hierarchy(stratified)
          .sum(d => d.data?.size ?? 0)
          .sort((a, b) => b.value - a.value);

        d3.treemap().size([width, height]).padding(1)(root);

        const totalBudget = flatData.reduce((sum, d) => sum + (d.size || 0), 0);

        const nodes = d3.select("svg").selectAll("g")
          .data(root.leaves())
          .join("g")
          .attr("transform", d => `translate(${d.x0},${d.y0})`);

        nodes.append("rect")
          .attr("width", d => d.x1 - d.x0)
          .attr("height", d => d.y1 - d.y0)
          .attr("fill", d => {
            const group = d.ancestors().find(a => a.depth === 1)?.data.id.split('.')[1];
            return colorScale(group);
          })
          .on("click", function (event, d) {
            const popup = document.getElementById("popup");
            const header = document.getElementById("popup-header");
            const content = document.getElementById("popup-content");
            const category = document.getElementById("popup-category");

            const name = d.data.id.split('.')[2] || 'Unknown';
            const size = d.data.data?.size || 0;
            const percent = ((size / totalBudget) * 100).toFixed(2);
            const desc = d.data.data?.description || "No description available.";
            const group = d.ancestors().find(a => a.depth === 1)?.data.id.split('.')[1];
            const color = colorScale(group);

            const formattedSize = size >= 1_000_000_000 ? (size / 1_000_000_000).toFixed(1) + 'B' :
              size >= 1_000_000 ? (size / 1_000_000).toFixed(1) + 'M' :
                size.toFixed(0);

            header.innerText = name;
            category.innerText = group;
            category.style.backgroundColor = color;
            category.style.color = isDarkColor(color) ? '#fff' : '#000';
            content.innerHTML = `${desc}<br><br>Budget: $${formattedSize} (${percent}%)`;

            popup.style.display = "block";
            const rect = event.target.getBoundingClientRect();
            popup.style.left = `${rect.left + window.scrollX + 10}px`;
            popup.style.top = `${rect.top + window.scrollY - popup.offsetHeight - 10}px`;
          });

        nodes.append("text").each(function (d) {
          const dept = d.data.data?.department_code || '';
          const size = d.data.data?.size ?? 0;
          const w = d.x1 - d.x0, h = d.y1 - d.y0;

          let label = '';
          if (size >= 1_000_000_000) {
            label = `$${(size / 1_000_000_000).toFixed(1)}B`;
          } else if (size >= 1_000_000) {
            label = `$${(size / 1_000_000).toFixed(1)}M`;
          } else {
            label = `$${size.toFixed(0)}`;
          }

          if (w > 70 && h > 30) {
            const t = d3.select(this);
            t.append("tspan").attr("x", 4).attr("y", 14).attr("font-weight", "bold").text(dept);
            t.append("tspan").attr("x", 4).attr("y", 30).attr("fill", "#666").attr("font-size", "14px").text(label);
          }
        });

        document.getElementById("popup-close").onclick = () => {
          document.getElementById("popup").style.display = "none";
        };

        if (window.pymChild) window.pymChild.sendHeight();
      }

      createLegend();
      render();

      document.getElementById("searchBox").addEventListener("input", function () {
        const query = this.value.toLowerCase();

        d3.selectAll("g").each(function (d) {
          const label = d.data.id.split('.')[2]?.toLowerCase() || '';
          const match = label.includes(query);

          // Update rectangle appearance
          d3.select(this).select("rect")
            .transition()
            .duration(200)
            .style("opacity", match || !query ? 1 : 0.15)
            .style("stroke", query && match ? "#000" : null)
            .style("stroke-width", query && match ? 3 : null);

          // Update label (text) opacity
          d3.select(this).select("text")
            .transition()
            .duration(200)
            .style("opacity", match || !query ? 1 : 0.15);
        });
      });



      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          render();
          if (window.pymChild) {
            window.pymChild.sendHeight();
          }
        }, 150);
      });
    });
  </script>
</body>

</html>